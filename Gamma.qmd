---
title: "Gamma"
format: html
---

```{r}
#| label: setup
#| message: false
#| warning: false

library(tidyverse)
library(brms)
library(posterior)
library(bayesplot)
library(ggdist)
library(patchwork)

color_scheme_set(scheme = "red")
theme_set(theme_ggdist())
```

## Gamma distribution

Shape ($\theta$) and Scale ($k$)

$$PDF(x)=\frac{1}{\Gamma(k)~\theta^k} x^{k - 1}~e^{-x/\theta}$$



Shape ($\alpha$) and Rate ($\beta$)

$$PDF(x) = \frac{\beta^\alpha}{\Gamma(\alpha)} x^{\alpha - 1}~e^{-\beta x}$$

Inverse scale parameter = rate

$$\beta = \frac{1}{\theta}$$


## Data

```{r}
set.seed(3475934)

x_mean <- 5
alpha <- 10
(beta <- alpha / y_mean)

n <- 1e4

GD <- tibble(x = rgamma(n, shape = shape, rate = rate))

ggplot(GD, aes(x)) +
  stat_slabinterval() +
ggplot(GD, aes(log(x))) +
  stat_slabinterval()
```


$$\bar{x} = \frac{\alpha}{\beta}$$

```{r}
alpha / beta
mean(GD$x)
```

$$Var(x) = \frac{\alpha}{\beta^2} $$

$$s = \sqrt{\frac{\alpha}{\beta^2}}$$

```{r}
alpha / (beta^2)
var(GD$x)

sqrt(alpha / (beta^2))
sd(GD$x)
```

## GLM and 

```{r}
summary(glm(x ~ 1, data = GD))
```


## Priors

```{r}
get_prior(x ~ 1,
          family = Gamma,
          data = GD)
```

```{r}
ggplot(tibble(x = rgamma(1e4, shape = 0.01, rate = 0.01)), aes(x)) +
  stat_slabinterval()
```


## Prior prediction

```{r}
PP <- brm(x ~ 1,
          family = Gamma,
          prior = prior(normal(1, 2.5), class = "Intercept", lb = 0) +
            prior(gamma(2, 2), class = "shape"),
          data = GD,
          sample_prior = "only")

(post <- as_draws_df(PP) |> 
  slice_sample(n = 200))

PP_lines <- map(.x = seq_len(nrow(post)),
    .f = function(ii, post){
      p_Intercept <- post$b_Intercept[ii]
      p_shape <- post$shape[ii]
      tibble(ii = ii,
             x = seq(0, 30, length.out = 100),
             y = dgamma(x, shape = p_shape, rate = p_Intercept / p_shape))
    }, post = post) |> 
  list_rbind()

ggplot() +
  geom_line(data = PP_lines, aes(x, y, group = ii),
            color = "firebrick4", alpha = 0.5) +
  geom_dotsinterval(data = GD, aes(x))
```


## brms model

```{r}
fm <- brm(x ~ 1, family = Gamma,
          data = GD,
          prior = prior(normal(1, 2.5), class = "Intercept", lb = 0) +
            prior(gamma(2, 2), class = "shape"),
          backend = "cmdstan")
```

```{r}
prior_summary(fm)
```

```{r}
pp_check(fm, ndraws = 100)
```


```{r}
post <- as_draws_df(fm)

mcmc_combo(fm, pars = c("b_Intercept", "shape"),
           combo = c("dens_overlay", "rank_overlay"))
```


```{r}
summary(fm)

1 / fixef(fm)
```

